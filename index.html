<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SepsisGuard — Altababa Clinical Pathway</title>
  <style>
    /* Calm, high-contrast bedside-friendly theme */
    :root{
      --bg:#0b1420; --panel:#0f1b2a; --card:#0b1220; --accent:#ff8c42; --muted:#9fb0c8; --danger:#ff4d4f; --ok:#10b981; --glass:rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg),#07101a);color:#e6eef6}
    .app{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    header h1{font-size:20px;margin:0}
    .row{display:flex;gap:12px}
    .card{background:linear-gradient(180deg,var(--card),#07101a);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .col{flex:1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=number],select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{background:var(--accent);border:none;color:#031219;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.06)}
    .small{font-size:12px;color:var(--muted)}
    .score{font-weight:700;font-size:18px;color:var(--accent)}
    .danger{color:var(--danger)}
    .ok{color:var(--ok)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .full{grid-column:1/-1}
    .timer{font-size:20px;font-weight:700}
    .log{max-height:180px;overflow:auto;background:var(--glass);padding:8px;border-radius:8px}
    .hidden{display:none}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px}
    .section{margin-top:12px}
    .warning{background:linear-gradient(90deg, rgba(255,140,66,0.08), rgba(255,140,66,0.02));padding:8px;border-radius:8px}
    footer{margin-top:14px;color:var(--muted);font-size:12px}
    
    /* New styles for tabs and records */
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{background:var(--glass);padding:8px 16px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.06)}
    .tab.active{background:var(--accent);color:#031219}
    .patient-list{display:flex;flex-direction:column;gap:8px}
    .patient-item{padding:12px;border-radius:8px;background:var(--glass);cursor:pointer}
    .patient-header{display:flex;justify-content:space-between;align-items:center}
    .patient-scores{display:flex;gap:12px;align-items:center}
    .patient-details{display:none;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06)}
    .patient-actions{display:flex;gap:8px;margin-top:8px}
    .trend{font-weight:bold;margin-left:4px}
    .trend-up{color:var(--danger)}
    .trend-down{color:var(--ok)}
    .trend-same{color:var(--muted)}
    .severity-mild{color:var(--ok)}
    .severity-moderate{color:#ffa500}
    .severity-severe{color:var(--danger)}
    .comparison-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px}
    .comparison-item{text-align:center;padding:8px;background:var(--glass);border-radius:8px}
    .comparison-value{font-weight:bold;font-size:16px}
    .comparison-diff{font-size:12px;margin-top:4px}
    .improved{color:var(--ok)}
    .worsened{color:var(--danger)}
    .unchanged{color:var(--muted)}
    .export-buttons{display:flex;gap:8px}
    
    /* ICU Alarm */
    .icu-alarm {
      background: linear-gradient(90deg, rgba(255, 77, 79, 0.1), rgba(255, 77, 79, 0.05));
      border: 1px solid var(--danger);
      padding: 12px;
      border-radius: 8px;
      animation: pulse 2s infinite;
      margin-top: 12px;
    }
    
    /* Severity color coding */
    .severity-shock {
      color: var(--danger);
      background: rgba(255, 77, 79, 0.2);
    }
    .severity-sepsis {
      color: #ffa500;
      background: rgba(255, 165, 0, 0.2);
    }
    .severity-suspected {
      color: #ffc107;
      background: rgba(255, 193, 7, 0.2);
    }
    .severity-none {
      color: var(--ok);
      background: rgba(16, 185, 129, 0.2);
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    @media(max-width:900px){.grid{grid-template-columns:1fr}.row{flex-direction:column}.comparison-grid{grid-template-columns:1fr}.export-buttons{flex-direction:column}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="card" style="padding:10px;display:flex;align-items:center;gap:12px">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15 8H9L12 2Z" fill="#ff8c42"/><circle cx="12" cy="16" r="6" fill="#063544"/></svg>
        <div>
          <h1>SepsisGuard — Altababa Clinical Pathway</h1>
          <div class="small">Clinical decision support by Dr. Thoraya Salah Murtada Sidahmed • Offline-ready</div>
        </div>
      </div>
    </header>

    <!-- Safety Notice -->
    <div class="card warning" style="margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:8px">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L3 20H21L12 2Z" stroke="var(--accent)" stroke-width="2"/>
          <path d="M12 10V14" stroke="var(--accent)" stroke-width="2"/>
          <circle cx="12" cy="17" r="1" fill="var(--accent)"/>
        </svg>
        <div class="small">
          <strong>SAFETY NOTICE:</strong> This tool supports clinical decisions but does not replace professional judgment. Verify all calculations and recommendations.
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="clinical">Clinical Decision</div>
      <div class="tab" data-tab="records">Patient Records</div>
    </div>

    <!-- Clinical Decision Tab -->
    <div id="clinicalTab" class="tab-content">
      <main class="row" style="margin-top:12px">
        <section class="card col">
          <h3>Patient & Triage</h3>
          <div class="grid">
            <div>
              <label>Name</label>
              <input id="name" type="text" placeholder="Patient name" />
            </div>
            <div>
              <label>MRN</label>
              <input id="mrn" type="text" placeholder="MRN" />
            </div>
            <div>
              <label>Weight (kg)</label>
              <input id="weight" type="number" step="0.1" />
            </div>
            <div>
              <label>Height (cm)</label>
              <input id="height" type="number" />
            </div>
            
            <!-- Brief History and Examination -->
            <div class="full">
              <label>Brief History</label>
              <textarea id="history" placeholder="Enter brief history (optional)" rows="2"></textarea>
            </div>
            
            <div class="full">
              <label>Brief Examination Findings</label>
              <textarea id="examination" placeholder="Enter brief examination findings (optional)" rows="2"></textarea>
            </div>
            
            <div>
              <label>Temperature (°C)</label>
              <input id="temp" type="number" step="0.1" />
            </div>
            <div>
              <label>Heart rate (bpm)</label>
              <input id="hr" type="number" />
            </div>
            <div>
              <label>Respiratory rate (bpm)</label>
              <input id="rr" type="number" />
            </div>
            <div>
              <label>Systolic BP (mmHg)</label>
              <input id="sbp" type="number" />
            </div>
            <div>
              <label>SpO₂ (%)</label>
              <input id="spo2" type="number" />
            </div>
            <div>
              <label>GCS (3-15)</label>
              <input id="gcs" type="number" min="3" max="15" />
            </div>
            <div>
              <label>Lactate (mmol/L)</label>
              <input id="lactate" type="number" step="0.1" />
            </div>
            <div class="full">
              <label>Other (check where applicable)</label>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <label><input id="recentChemo" type="checkbox"> Recent chemotherapy</label>
                <label><input id="indwellingLine" type="checkbox"> Indwelling line</label>
                <label><input id="noUrine18" type="checkbox"> No urine for 18h</label>
                <label><input id="hypergly" type="checkbox"> Hyperglycemia &gt;120 (no DM)</label>
              </div>
            </div>

            <div class="full" style="display:flex;gap:8px;align-items:center">
              <button id="assess" style="flex:1">Assess & Calculate Scores</button>
              <button id="savePatient" class="secondary">Save Patient</button>
            </div>
            <div class="full small">Results: NEWS2 <span id="news2" class="score">-</span> • qSOFA <span id="qsofa" class="score">-</span> • Severity: <span id="severity" class="pill">-</span></div>
          </div>

          <!-- Comparison Section -->
          <div id="comparisonSection" class="section hidden">
            <h4>Comparison with Previous Assessment</h4>
            <div id="comparisonContent" class="comparison-grid"></div>
          </div>
        </section>

        <!-- Right column: dynamic area for triggered modules -->
        <aside class="col">
          <div id="dynamicArea" class="card">
            <h3>Clinical Guidance</h3>
            <div class="small">After clicking <strong>Assess & Calculate Scores</strong>, appropriate guidance modules will appear here.</div>
            <div id="dynamicContent"></div>
          </div>

          <!-- Combined Antibiotic Section -->
          <div id="antibioticSection" class="card section hidden">
            <h3>Antibiotic Management</h3>
            
            <!-- Antibiotic Wizard -->
            <div class="section">
              <h4>Antibiotic Selection Wizard</h4>
              <div class="grid">
                <div><label>Suspected source</label><select id="src"><option value="unknown">Unknown</option><option value="pneumonia">Pneumonia</option><option value="uti">UTI</option><option value="intraab">Intra-abdominal</option><option value="softt">Soft tissue</option><option value="cns">CNS</option></select></div>
                <div><label>Penicillin allergy?</label><select id="pen"><option value="no">No</option><option value="yes">Yes</option></select></div>
                <div><label>MDR risk?</label><select id="mdr"><option value="no">No</option><option value="yes">Yes</option></select></div>
                <div style="grid-column:1/-1"><button id="suggestAbx" class="action">Suggest Regimen</button></div>
                <div id="abxOut" class="full small"></div>
              </div>
            </div>

            <!-- Antibiotic Dose Calculator -->
            <div class="section">
              <h4>Antibiotic Dose Calculator</h4>
              <div class="grid">
                <div>
                  <label>Antibiotic</label>
                  <select id="abxSelect">
                    <option value="ceftriaxone">Ceftriaxone</option>
                    <option value="vancomycin">Vancomycin</option>
                    <option value="gentamicin">Gentamicin</option>
                    <option value="pip-taz">Piperacillin-Tazobactam</option>
                  </select>
                </div>
                <div>
                  <label>Weight (kg)</label>
                  <input id="abxWeight" type="number" step="0.1" placeholder="From patient data" />
                </div>
                <div class="full">
                  <button id="calculateDose" class="action">Calculate Dose</button>
                  <div id="doseResult" class="small" style="margin-top:8px"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Noradrenaline Calculator Section -->
          <div id="noradrenalineSection" class="card section hidden">
            <h3>Noradrenaline Rate Calculator</h3>
            <div class="small" style="margin-bottom:12px">For persistent hypotension requiring vasopressor support</div>
            
            <div class="grid">
              <div>
                <label>Patient Weight (kg)</label>
                <input id="norWeight" type="number" step="0.1" placeholder="From patient data" />
              </div>
              <div>
                <label>Fluid Volume (ml)</label>
                <input id="norFluid" type="number" placeholder="e.g., 250 ml" />
              </div>
              <div>
                <label>Noradrenaline Concentration (mg)</label>
                <select id="norConcentration">
                  <option value="2">2 mg (Low concentration)</option>
                  <option value="4">4 mg (Standard)</option>
                  <option value="8">8 mg (High concentration)</option>
                  <option value="16">16 mg (Very high concentration)</option>
                  <option value="32">32 mg (Maximum concentration)</option>
                </select>
              </div>
              <div class="full">
                <button id="calculateNoradrenaline" class="action">Calculate Noradrenaline Rate</button>
              </div>
            </div>
            
            <div id="norResult" class="section" style="display:none;">
              <h4>Noradrenaline Infusion Rates</h4>
              <div class="grid">
                <div>
                  <label>Minimum Rate (0.5 mcg/kg/min)</label>
                  <div class="score" id="norMinRate">-</div>
                </div>
                <div>
                  <label>Maximum Rate (1 mcg/kg/min)</label>
                  <div class="score" id="norMaxRate">-</div>
                </div>
              </div>
              <div id="icuAlarm" class="icu-alarm hidden">
                <div style="display:flex;align-items:center;gap:8px">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L3 20H21L12 2Z" stroke="var(--danger)" stroke-width="2"/>
                    <path d="M12 10V14" stroke="var(--danger)" stroke-width="2"/>
                    <circle cx="12" cy="17" r="1" fill="var(--danger)"/>
                  </svg>
                  <div>
                    <strong>ICU CONSULTATION REQUIRED</strong><br>
                    <span class="small">Persistent hypotension requiring noradrenaline infusion. Immediate ICU team consultation needed.</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Combined Logs Section -->
          <div class="card section">
            <h3>Clinical Documentation</h3>
            
            <!-- Sepsis Bundle Log -->
            <div id="bundleLogSection" class="section hidden">
              <h4>Sepsis Bundle Progress</h4>
              <div id="bundleLog" class="log" style="max-height:120px"></div>
            </div>

            <!-- Audit & Event Log -->
            <div class="section">
              <h4>Audit & Event Log</h4>
              <div id="eventLog" class="log"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="eventText" type="text" placeholder="Note an event or override" />
                <button id="addEvent" class="secondary">Add</button>
              </div>
            </div>
          </div>
        </aside>
      </main>
    </div>

    <!-- Patient Records Tab -->
    <div id="recordsTab" class="tab-content hidden">
      <div class="card">
        <h3>Patient Records</h3>
        <div class="small" style="margin-bottom:12px">Select a patient to review or add follow-up assessment</div>
        <div id="patientList" class="patient-list"></div>
      </div>
    </div>

    <footer class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <div class="small">
          <strong>SepsisGuard — Altababa Clinical Pathway v1.0 (TRIAL)</strong><br>
          Developed by Dr. Thoraya Salah Murtada Sidahmed<br>
          Contact: <a href="mailto:thorayagzzar@gmail.com" style="color:var(--accent)">thorayagzzar@gmail.com</a> for suggestions & technical issues<br>
          <div style="margin-top:4px;color:var(--danger)">
            <strong>SECURITY:</strong> Data stored locally only • No internet transmission • For authorized users only
          </div>
        </div>
        <div class="export-buttons">
          <button id="exportExcel" class="secondary">Export Excel</button>
          <button id="exportPDF" class="secondary">Export PDF</button>
          <button id="clearAll" class="secondary">Clear Data</button>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // Utility
    const $ = id => document.getElementById(id);
    function log(msg){ 
      const el = $('eventLog'); 
      el.innerHTML = `<div>[${new Date().toLocaleString()}] ${escapeHtml(msg)}</div>` + el.innerHTML; 
      localStorage.setItem('eventLog', el.innerHTML); 
    }
    
    function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    // Patient Data Management
    function getAllPatients() {
      return JSON.parse(localStorage.getItem('patients') || '{}');
    }

    function savePatient(patientData) {
      const patients = getAllPatients();
      const patientName = patientData.name?.trim();
      if (!patientName) return null;

      const now = new Date().toISOString();
      const existingPatient = patients[patientName];
      
      if (existingPatient) {
        patientData.previousNEWS = existingPatient.news2;
        patientData.previousData = {
          news2: existingPatient.news2,
          qsofa: existingPatient.qsofa,
          severity: existingPatient.severity,
          temp: existingPatient.temp,
          hr: existingPatient.hr,
          rr: existingPatient.rr,
          sbp: existingPatient.sbp,
          spo2: existingPatient.spo2,
          gcs: existingPatient.gcs,
          lactate: existingPatient.lactate,
          history: existingPatient.history,
          examination: existingPatient.examination
        };
        patientData.assessmentHistory = existingPatient.assessmentHistory || [];
        patientData.assessmentHistory.push({
          timestamp: existingPatient.lastUpdated,
          news2: existingPatient.news2,
          qsofa: existingPatient.qsofa,
          severity: existingPatient.severity,
          data: {
            temp: existingPatient.temp,
            hr: existingPatient.hr,
            rr: existingPatient.rr,
            sbp: existingPatient.sbp,
            spo2: existingPatient.spo2,
            gcs: existingPatient.gcs,
            lactate: existingPatient.lactate,
            history: existingPatient.history,
            examination: existingPatient.examination
          }
        });
      } else {
        patientData.assessmentHistory = [];
      }

      patientData.lastUpdated = now;
      patients[patientName] = patientData;
      localStorage.setItem('patients', JSON.stringify(patients));
      return patientName;
    }

    function deletePatient(patientName) {
      const patients = getAllPatients();
      delete patients[patientName];
      localStorage.setItem('patients', JSON.stringify(patients));
      renderPatientList();
      log(`Patient discharged: ${patientName}`);
    }

    function loadPatientForFollowup(patientName) {
      const patients = getAllPatients();
      const patient = patients[patientName];
      if (!patient) return;

      // Switch to clinical tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      $('clinicalTab').classList.remove('hidden');
      document.querySelector('[data-tab="clinical"]').classList.add('active');

      // Fill form with patient data
      ['name', 'mrn', 'weight', 'height', 'history', 'examination'].forEach(field => {
        if (patient[field]) $(field).value = patient[field];
      });

      // Show comparison if previous data exists
      if (patient.previousData) {
        showComparison(patient.previousData, patient);
      }

      log(`Loaded patient ${patientName} for follow-up assessment`);
    }

    function showComparison(previousData, currentData) {
      const comparisonContent = $('comparisonContent');
      comparisonContent.innerHTML = '';

      const metrics = [
        { key: 'news2', label: 'NEWS2', format: v => v || '-' },
        { key: 'qsofa', label: 'qSOFA', format: v => v || '-' },
        { key: 'temp', label: 'Temp (°C)', format: v => v ? v.toFixed(1) : '-' },
        { key: 'hr', label: 'HR', format: v => v || '-' },
        { key: 'rr', label: 'RR', format: v => v || '-' },
        { key: 'sbp', label: 'SBP', format: v => v || '-' },
        { key: 'spo2', label: 'SpO₂%', format: v => v || '-' },
        { key: 'gcs', label: 'GCS', format: v => v || '-' },
        { key: 'lactate', label: 'Lactate', format: v => v ? v.toFixed(1) : '-' }
      ];

      metrics.forEach(metric => {
        const prev = previousData[metric.key];
        const curr = currentData[metric.key];
        
        let diff = '';
        let diffClass = 'unchanged';
        
        if (prev !== undefined && curr !== undefined && prev !== null && curr !== null) {
          if (metric.key === 'spo2' || metric.key === 'gcs') {
            // Higher is better
            if (curr > prev) {
              diff = `+${curr - prev}`;
              diffClass = 'improved';
            } else if (curr < prev) {
              diff = `${curr - prev}`;
              diffClass = 'worsened';
            }
          } else {
            // Lower is better for other metrics
            if (curr < prev) {
              diff = `${curr - prev}`;
              diffClass = 'improved';
            } else if (curr > prev) {
              diff = `+${curr - prev}`;
              diffClass = 'worsened';
            }
          }
        }

        const item = document.createElement('div');
        item.className = 'comparison-item';
        item.innerHTML = `
          <div class="small">${metric.label}</div>
          <div class="comparison-value">${metric.format(curr)}</div>
          ${diff ? `<div class="comparison-diff ${diffClass}">${diff}</div>` : ''}
        `;
        comparisonContent.appendChild(item);
      });

      $('comparisonSection').classList.remove('hidden');
    }

    // Export Functions
    function exportToExcel() {
      const patients = getAllPatients();
      if (Object.keys(patients).length === 0) {
        alert('No patient data to export');
        return;
      }

      let csvContent = "Patient Name,MRN,Weight,History,Examination,Last Updated,NEWS2,qSOFA,Severity,Temp,HR,RR,SBP,SpO2,GCS,Lactate,Risk Factors\n";
      
      Object.entries(patients).forEach(([name, data]) => {
        const riskFactors = [];
        if (data.recentChemo) riskFactors.push('Recent chemo');
        if (data.indwellingLine) riskFactors.push('Indwelling line');
        if (data.noUrine18) riskFactors.push('Oliguria');
        if (data.hypergly) riskFactors.push('Hyperglycemia');
        
        const row = [
          `"${name}"`,
          data.mrn || '',
          data.weight || '',
          `"${data.history || ''}"`,
          `"${data.examination || ''}"`,
          new Date(data.lastUpdated).toLocaleString(),
          data.news2 || '',
          data.qsofa || '',
          data.severity || '',
          data.temp || '',
          data.hr || '',
          data.rr || '',
          data.sbp || '',
          data.spo2 || '',
          data.gcs || '',
          data.lactate || '',
          `"${riskFactors.join(', ')}"`
        ].join(',');
        
        csvContent += row + '\n';
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `SepsisGuard_Export_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      log('Data exported to Excel/CSV format');
    }

    function exportToPDF() {
      const patients = getAllPatients();
      if (Object.keys(patients).length === 0) {
        alert('No patient data to export');
        return;
      }

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>SepsisGuard Export</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
            .patient { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
            .patient-header { background: #f5f5f5; padding: 10px; margin: -15px -15px 15px -15px; }
            .scores { display: flex; gap: 20px; margin: 10px 0; }
            .score-item { padding: 5px 10px; background: #e9e9e9; border-radius: 3px; }
            .vitals { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
            @media print {
              body { margin: 0; }
              .patient { break-inside: avoid; }
            }
          </style>
        </head>
        <body>
          <h1>SepsisGuard - Patient Export</h1>
          <p>Generated: ${new Date().toLocaleString()}</p>
          <p>Developed by Dr. Thoraya Salah Murtada Sidahmed</p>
          <p>Altababa Clinical Pathway</p>
          <hr>
      `);

      Object.entries(patients).forEach(([name, data]) => {
        const riskFactors = [];
        if (data.recentChemo) riskFactors.push('Recent chemo');
        if (data.indwellingLine) riskFactors.push('Indwelling line');
        if (data.noUrine18) riskFactors.push('Oliguria');
        if (data.hypergly) riskFactors.push('Hyperglycemia');

        printWindow.document.write(`
          <div class="patient">
            <div class="patient-header">
              <h2>${escapeHtml(name)}</h2>
              <p>MRN: ${data.mrn || 'N/A'} | Last Updated: ${new Date(data.lastUpdated).toLocaleString()}</p>
            </div>
            ${data.history ? `<p><strong>History:</strong> ${escapeHtml(data.history)}</p>` : ''}
            ${data.examination ? `<p><strong>Examination:</strong> ${escapeHtml(data.examination)}</p>` : ''}
            <div class="scores">
              <div class="score-item">NEWS2: <strong>${data.news2 || '-'}</strong></div>
              <div class="score-item">qSOFA: <strong>${data.qsofa || '-'}</strong></div>
              <div class="score-item">Severity: <strong>${data.severity || '-'}</strong></div>
            </div>
            <div class="vitals">
              <div>Temp: ${data.temp || '-'}°C</div>
              <div>HR: ${data.hr || '-'} bpm</div>
              <div>RR: ${data.rr || '-'} bpm</div>
              <div>SBP: ${data.sbp || '-'} mmHg</div>
              <div>SpO₂: ${data.spo2 || '-'}%</div>
              <div>GCS: ${data.gcs || '-'}</div>
              <div>Lactate: ${data.lactate || '-'} mmol/L</div>
              <div>Weight: ${data.weight || '-'} kg</div>
            </div>
            <p><strong>Risk Factors:</strong> ${riskFactors.length > 0 ? riskFactors.join(', ') : 'None'}</p>
            ${data.assessmentHistory && data.assessmentHistory.length > 0 ? `
              <p><strong>Assessment History:</strong></p>
              <ul>
                ${data.assessmentHistory.slice(-3).map(assessment => 
                  `<li>${new Date(assessment.timestamp).toLocaleString()}: NEWS ${assessment.news2} (${assessment.severity})</li>`
                ).join('')}
              </ul>
            ` : ''}
          </div>
          <hr>
        `);
      });

      printWindow.document.write('</body></html>');
      printWindow.document.close();
      
      setTimeout(() => {
        printWindow.print();
        log('Data exported to PDF format');
      }, 500);
    }

    // Tab Management
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        
        tab.classList.add('active');
        $(tab.dataset.tab + 'Tab').classList.remove('hidden');
        
        if (tab.dataset.tab === 'records') {
          renderPatientList();
        }
      });
    });

    // Render Patient List
    function renderPatientList() {
      const container = $('patientList');
      const patients = getAllPatients();
      
      if (Object.keys(patients).length === 0) {
        container.innerHTML = '<div class="small">No patients recorded yet. Use the Clinical Decision tab to assess patients.</div>';
        return;
      }

      container.innerHTML = '';
      Object.entries(patients).sort((a, b) => new Date(b[1].lastUpdated) - new Date(a[1].lastUpdated)).forEach(([name, data]) => {
        const trend = data.previousNEWS !== undefined ? 
          (data.news2 > data.previousNEWS ? '↑' : 
           data.news2 < data.previousNEWS ? '↓' : '→') : '→';
        
        const trendClass = trend === '↑' ? 'trend-up' : trend === '↓' ? 'trend-down' : 'trend-same';
        
        // Determine severity class for display
        let severityClass = 'severity-none';
        if (data.severity?.includes('SHOCK')) severityClass = 'severity-shock';
        else if (data.severity?.includes('SEPSIS') && !data.severity?.includes('SUSPECTED')) severityClass = 'severity-sepsis';
        else if (data.severity?.includes('SUSPECTED')) severityClass = 'severity-suspected';

        const item = document.createElement('div');
        item.className = 'patient-item';
        item.innerHTML = `
          <div class="patient-header">
            <div>
              <strong>${escapeHtml(name)}</strong>
              <div class="small">Last updated: ${new Date(data.lastUpdated).toLocaleString()}</div>
            </div>
            <div class="patient-scores">
              <div>NEWS: <span class="score">${data.news2 || '-'}</span> <span class="trend ${trendClass}">${trend}</span></div>
              <div>qSOFA: <span class="score">${data.qsofa || '-'}</span></div>
              <div class="pill ${severityClass}">${data.severity || '-'}</div>
            </div>
          </div>
          <div class="patient-details">
            <div class="grid">
              ${data.history ? `<div class="full"><strong>History:</strong> ${escapeHtml(data.history)}</div>` : ''}
              ${data.examination ? `<div class="full"><strong>Examination:</strong> ${escapeHtml(data.examination)}</div>` : ''}
              <div><strong>Vitals:</strong> Temp: ${data.temp || '-'}°C, HR: ${data.hr || '-'}, RR: ${data.rr || '-'}</div>
              <div><strong>Status:</strong> BP: ${data.sbp || '-'}, SpO₂: ${data.spo2 || '-'}%, GCS: ${data.gcs || '-'}</div>
              <div class="full"><strong>Risk Factors:</strong> ${getRiskFactorsText(data)}</div>
              ${data.assessmentHistory && data.assessmentHistory.length > 0 ? `
                <div class="full">
                  <strong>Assessment History:</strong>
                  <div class="small">
                    ${data.assessmentHistory.slice(-3).map(assessment => 
                      `${new Date(assessment.timestamp).toLocaleString()}: NEWS ${assessment.news2} (${assessment.severity})`
                    ).join('<br>')}
                  </div>
                </div>
              ` : ''}
            </div>
            <div class="patient-actions">
              <button class="secondary review-patient" data-name="${escapeHtml(name)}">Review Case</button>
              <button class="followup-patient" data-name="${escapeHtml(name)}">Add Follow-up</button>
              <button class="secondary delete-patient" data-name="${escapeHtml(name)}">Discharge</button>
            </div>
          </div>
        `;
        
        container.appendChild(item);

        // Add click handler for expand/collapse
        item.querySelector('.patient-header').addEventListener('click', (e) => {
          if (!e.target.classList.contains('review-patient') && !e.target.classList.contains('followup-patient') && !e.target.classList.contains('delete-patient')) {
            const details = item.querySelector('.patient-details');
            details.style.display = details.style.display === 'block' ? 'none' : 'block';
          }
        });

        // Add action handlers
        item.querySelector('.review-patient').addEventListener('click', (e) => {
          e.stopPropagation();
          const patientName = e.target.dataset.name;
          loadPatientForFollowup(patientName);
        });

        item.querySelector('.followup-patient').addEventListener('click', (e) => {
          e.stopPropagation();
          const patientName = e.target.dataset.name;
          loadPatientForFollowup(patientName);
        });

        item.querySelector('.delete-patient').addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm(`Discharge patient ${name}? This will remove them from records.`)) {
            deletePatient(name);
          }
        });
      });
    }

    function getRiskFactorsText(patient) {
      const factors = [];
      if (patient.recentChemo) factors.push('Recent chemo');
      if (patient.indwellingLine) factors.push('Indwelling line');
      if (patient.noUrine18) factors.push('Oliguria');
      if (patient.hypergly) factors.push('Hyperglycemia');
      return factors.length > 0 ? factors.join(', ') : 'None';
    }

    // Antibiotic Dose Calculator
    function calculateAntibioticDose(antibiotic, weight) {
      const doses = {
        ceftriaxone: { dose: '1-2 g', frequency: 'q24h', notes: 'IV' },
        vancomycin: { dose: '15-20 mg/kg', frequency: 'q8-12h', notes: 'Monitor levels' },
        gentamicin: { dose: '5-7 mg/kg', frequency: 'q24h', notes: 'Once daily dosing' },
        'pip-taz': { dose: '4.5 g', frequency: 'q6-8h', notes: 'Extended infusion for critical illness' }
      };
      
      const info = doses[antibiotic];
      if (!info) return 'Antibiotic not found';
      
      let calculatedDose = info.dose;
      if (antibiotic === 'vancomycin' && weight) {
        const doseMg = Math.round(weight * 17.5);
        calculatedDose = `${doseMg} mg (${info.dose})`;
      } else if (antibiotic === 'gentamicin' && weight) {
        const doseMg = Math.round(weight * 6);
        calculatedDose = `${doseMg} mg (${info.dose})`;
      }
      
      return `${calculatedDose} ${info.frequency} ${info.notes}`;
    }

    // Noradrenaline Rate Calculator
    function calculateNoradrenalineRate(weight, fluidVolume, concentration) {
      if (!weight || !fluidVolume || !concentration) {
        return null;
      }
      
      // Calculate rates based on provided formulas:
      // Minimum Rate = (0.5 * fluid ml * weight kg * 60) / (fluid concentration * 1000)
      // Maximum Rate = (1 * fluid ml * weight kg * 60) / (fluid concentration * 1000)
      
      const minRate = (0.5 * fluidVolume * weight * 60) / (concentration * 1000);
      const maxRate = (1 * fluidVolume * weight * 60) / (concentration * 1000);
      
      return {
        min: minRate.toFixed(2),
        max: maxRate.toFixed(2)
      };
    }

    // Load event log and patients on startup
    window.addEventListener('load',()=>{ 
      if(localStorage.getItem('eventLog')) $('eventLog').innerHTML = localStorage.getItem('eventLog'); 
      renderPatientList();
    });

    // Save patient handler
    $('savePatient').addEventListener('click',()=>{
      const patient = collectInputs();
      const patientName = savePatient(patient);
      if (patientName) {
        log('Patient saved: ' + patientName);
        alert('Patient saved locally.');
        renderPatientList();
        $('comparisonSection').classList.add('hidden');
      }
    });

    // Add event handler
    $('addEvent').addEventListener('click',()=>{ 
      const t = $('eventText').value.trim(); 
      if(!t) return; 
      log(t); 
      $('eventText').value=''; 
    });

    // Export button handlers
    $('exportExcel').addEventListener('click', exportToExcel);
    $('exportPDF').addEventListener('click', exportToPDF);
    
    // Clear all data
    $('clearAll').addEventListener('click',()=>{ 
      if(!confirm('Clear all local data?')) return; 
      localStorage.clear(); 
      location.reload(); 
    });

    // Antibiotic calculator handler
    $('calculateDose').addEventListener('click',()=>{
      const antibiotic = $('abxSelect').value;
      const weight = parseFloat($('abxWeight').value) || parseFloat($('weight').value);
      
      if (!weight) {
        alert('Please enter patient weight');
        return;
      }
      
      const dose = calculateAntibioticDose(antibiotic, weight);
      $('doseResult').innerHTML = `<strong>Recommended dose:</strong> ${dose}`;
      log(`Antibiotic calculated: ${antibiotic} - ${dose}`);
    });

    // Noradrenaline calculator handler
    $('calculateNoradrenaline').addEventListener('click',()=>{
      const weight = parseFloat($('norWeight').value) || parseFloat($('weight').value);
      const fluidVolume = parseFloat($('norFluid').value);
      const concentration = parseFloat($('norConcentration').value);
      
      if (!weight || !fluidVolume || !concentration) {
        alert('Please enter weight, fluid volume, and select concentration');
        return;
      }
      
      const rates = calculateNoradrenalineRate(weight, fluidVolume, concentration);
      
      if (rates) {
        $('norMinRate').textContent = rates.min + ' ml/hr';
        $('norMaxRate').textContent = rates.max + ' ml/hr';
        $('norResult').style.display = 'block';
        
        // Show ICU alarm since noradrenaline is being calculated
        $('icuAlarm').classList.remove('hidden');
        
        log(`Noradrenaline calculated: Min ${rates.min} ml/hr, Max ${rates.max} ml/hr`);
        log('ICU consultation alarm triggered - persistent hypotension requiring noradrenaline');
      }
    });

    // Show antibiotic section when weight is available
    function toggleAntibioticSection() {
      const weight = parseFloat($('weight').value);
      if (weight) {
        $('antibioticSection').classList.remove('hidden');
        $('abxWeight').value = weight;
        $('norWeight').value = weight;
      } else {
        $('antibioticSection').classList.add('hidden');
        $('noradrenalineSection').classList.add('hidden');
      }
    }

    // Show noradrenaline section when hypotension is detected
    function toggleNoradrenalineSection(inputs) {
      if (inputs.sbp !== null && inputs.sbp < 90) {
        $('noradrenalineSection').classList.remove('hidden');
        if (inputs.weight) {
          $('norWeight').value = inputs.weight;
        }
        log('Persistent hypotension detected - noradrenaline calculator activated');
        return true;
      } else {
        $('noradrenalineSection').classList.add('hidden');
        $('norResult').style.display = 'none';
        $('icuAlarm').classList.add('hidden');
        return false;
      }
    }

    $('weight').addEventListener('input', toggleAntibioticSection);

    // Antibiotic wizard handler
    $('suggestAbx').addEventListener('click',()=>{
      const s=$('src').value, pen=$('pen').value, mdr=$('mdr').value; let txt='';
      if(s==='pneumonia'){
        if(mdr==='no' && pen==='no') txt='Ceftriaxone 1-2 g IV q24h OR Cefotaxime 1-2 g IV q8h + Azithromycin.';
        else if(mdr==='yes') txt='Piperacillin/Tazobactam 4.5 g IV q8h OR Imipenem/Meropenem. Add MRSA coverage if risk.';
        else if(pen==='yes') txt='Levofloxacin 500 mg IV q12h or Moxifloxacin.';
      } else if(s==='uti'){ txt = (mdr==='yes')? 'Meropenem/Imipenem for ESBL suspicion':'Ceftriaxone 1 g IV q24h or Gentamicin 5 mg/kg IV once daily'; }
      else if(s==='intraab'){ txt='Piperacillin/Tazobactam OR Ceftriaxone + Metronidazole; carbapenem if ESBL suspected.'; }
      else if(s==='softt'){ txt = (pen==='no')? 'Flucloxacillin 2 g IV q6h +/- Metronidazole':'Clindamycin or Tigecycline if severe allergy.'; }
      else if(s==='cns'){ txt='Ceftriaxone 2 g IV q12h + Vancomycin; add Ampicillin for Listeria when indicated.'; }
      else { txt=(mdr==='yes')? 'Broad-spectrum: Piperacillin/Tazobactam or Carbapenem + Vancomycin if MRSA suspected':'Piperacillin/Tazobactam or Ceftriaxone + Gentamicin'; }
      $('abxOut').innerText = txt; log('Antibiotic suggestion: '+txt);
    });

    function collectInputs(){ 
      return {
        name: $('name').value, 
        mrn: $('mrn').value, 
        weight: parseFloat($('weight').value) || null, 
        height: parseFloat($('height').value) || null,
        history: $('history').value, 
        examination: $('examination').value,
        temp: parseFloat($('temp').value) || null, 
        hr: parseInt($('hr').value) || null, 
        rr: parseInt($('rr').value) || null, 
        sbp: parseInt($('sbp').value) || null,
        spo2: parseInt($('spo2').value) || null, 
        gcs: parseInt($('gcs').value) || null, 
        lactate: parseFloat($('lactate').value) || null,
        recentChemo: $('recentChemo').checked, 
        indwellingLine: $('indwellingLine').checked, 
        noUrine18: $('noUrine18').checked, 
        hypergly: $('hypergly').checked
      }; 
    }

    // MEDICALLY ACCURATE SCORING FUNCTIONS (Sepsis-3 Guidelines)

    // Calculate NEWS2 score
    function calcNEWS2(temp, hr, rr, sbp, spo2, supplementalO2 = false) {
      let score = 0;
      
      // Respiratory rate
      if (rr <= 8) score += 3;
      else if (rr >= 25) score += 3;
      else if (rr >= 21) score += 2;
      else if (rr >= 12) score += 1;
      
      // Oxygen saturation
      if (spo2 <= 91) score += 3;
      else if (spo2 <= 93) score += 2;
      else if (spo2 <= 95) score += 1;
      // If on supplemental O2, add 2 points to any SpO2 score
      if (supplementalO2 && spo2 <= 96) score += 2;
      
      // Temperature
      if (temp <= 35.0) score += 3;
      else if (temp >= 39.1) score += 2;
      else if (temp >= 38.1 || temp <= 36.0) score += 1;
      
      // Systolic BP
      if (sbp <= 90) score += 3;
      else if (sbp <= 100) score += 2;
      else if (sbp <= 110) score += 1;
      
      // Heart rate
      if (hr <= 40 || hr >= 131) score += 3;
      else if (hr >= 111) score += 2;
      else if (hr >= 91 || hr <= 50) score += 1;
      
      return score;
    }

    // Calculate qSOFA score (Sepsis-3)
    function calcQSOFA(rr, sbp, gcs) {
      let score = 0;
      // qSOFA criteria (Sepsis-3):
      // 1. Respiratory rate ≥ 22/min
      // 2. Altered mentation (GCS < 15)
      // 3. Systolic BP ≤ 100 mmHg
      if (rr >= 22) score++;
      if (gcs < 15) score++;
      if (sbp <= 100) score++;
      return score;
    }

    // Determine sepsis severity based on Sepsis-3 guidelines
    function determineSeverity(inputs, news, qsofa) {
      const redFlags = [];
      const recommendations = [];
      
      // Organ dysfunction indicators (Sepsis-3 criteria)
      if (inputs.sbp !== null && inputs.sbp < 90) redFlags.push('Hypotension SBP<90');
      if (inputs.rr !== null && inputs.rr >= 22) redFlags.push('Tachypnea RR≥22');
      if (inputs.gcs !== null && inputs.gcs < 15) redFlags.push('Altered mentation GCS<15');
      if (inputs.lactate !== null && inputs.lactate >= 2) redFlags.push('Lactate ≥2 mmol/L');
      if (inputs.noUrine18) redFlags.push('Oliguria (<0.5 ml/kg/hr for 18h)');
      if (inputs.spo2 !== null && inputs.spo2 < 90) redFlags.push('Hypoxia SpO2<90%');
      
      // Additional risk factors
      if (inputs.recentChemo) redFlags.push('Immunocompromised (recent chemo)');
      if (inputs.indwellingLine) redFlags.push('Indwelling line (infection risk)');
      if (inputs.hypergly) redFlags.push('Stress hyperglycemia');

      // SEPSIS-3 CLASSIFICATION LOGIC
      let level = 'NO SEPSIS';
      let icuAlert = false;
      
      // Check for Septic Shock (Sepsis-3 criteria)
      const hasPersistentHypotension = inputs.sbp !== null && inputs.sbp < 90;
      const hasHighLactate = inputs.lactate !== null && inputs.lactate > 2;
      const hasSepticShock = hasPersistentHypotension && hasHighLactate;
      
      // Check for Sepsis (qSOFA ≥ 2 or NEWS2 ≥ 5 with organ dysfunction)
      const hasSepsis = (qsofa >= 2) || (news >= 5 && redFlags.length > 0);
      
      // Check for Suspected Sepsis
      const hasSuspectedSepsis = (qsofa >= 1 || news >= 3) && redFlags.length > 0;

      // Determine final classification
      if (hasSepticShock) {
        level = 'SEPTIC SHOCK';
        icuAlert = true;
        recommendations.push('IMMEDIATE ICU TRANSFER REQUIRED');
        recommendations.push('Start vasopressors (Noradrenaline first-line)');
        recommendations.push('Broad-spectrum antibiotics within 1 hour');
        recommendations.push('Fluid resuscitation 30 ml/kg crystalloid');
        recommendations.push('Source control within 6-12 hours');
      } else if (hasSepsis) {
        level = 'SEPSIS';
        icuAlert = true;
        recommendations.push('URGENT ESCALATION - Consider HDU/ICU');
        recommendations.push('Antibiotics within 1 hour');
        recommendations.push('Fluid resuscitation 20-30 ml/kg');
        recommendations.push('Repeat lactate in 2-4 hours');
        recommendations.push('Consider source control');
      } else if (hasSuspectedSepsis) {
        level = 'SUSPECTED SEPSIS';
        recommendations.push('Monitor closely (vitals Q1-4h)');
        recommendations.push('Obtain cultures before antibiotics if possible');
        recommendations.push('Consider early antibiotics');
        recommendations.push('Fluid challenge if indicated');
      } else {
        level = 'NO SEPSIS';
        recommendations.push('Continue routine monitoring');
        recommendations.push('Consider alternative diagnoses');
      }
      
      return {
        level: level,
        redFlags: redFlags,
        icuAlert: icuAlert,
        recommendations: recommendations,
        qsofa: qsofa,
        news2: news
      };
    }

    // Timer and dynamic modules
    let bundleTimerId = null; 
    let bundleStart = null; 
    
    function startBundleTimer() { 
      bundleStart = Date.now(); 
      localStorage.setItem('bundleStart', bundleStart); 
      if (bundleTimerId) clearInterval(bundleTimerId); 
      bundleTimerId = setInterval(() => {
        const elapsed = Math.floor((Date.now() - bundleStart) / 1000);
        const remaining = 60 * 60 - elapsed; // 60-minute bundle for septic shock
        const mm = String(Math.floor(Math.abs(remaining) / 60)).padStart(2, '0');
        const ss = String(Math.abs(remaining) % 60).padStart(2, '0');
        document.querySelectorAll('.bundle-timer').forEach(x => x.innerText = (remaining >= 0 ? mm + ':' + ss : '+' + mm + ':' + ss));
        document.querySelectorAll('.bundle-timer').forEach(x => x.style.color = (remaining < 0 ? 'var(--danger)' : 'var(--accent)'));
      }, 500);
    }

    function clearDynamic() { 
      $('dynamicContent').innerHTML = ''; 
      $('bundleLogSection').classList.add('hidden');
    }

    function renderSepsisSix() {
      const container = document.createElement('div'); 
      container.className = 'section';
      container.innerHTML = `
        <h4>Sepsis Six (1-Hour Bundle for Septic Shock)</h4>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button id="startBundleBtn">Start Bundle Timer</button>
          <div class="small">Timer: <span class="bundle-timer">60:00</span></div>
          <div class="small">Progress: <span id="bundleProgress" class="pill">0/6</span></div>
        </div>
        <div class="grid">
          <label class="full"><input type="checkbox" id="c_bloodcult"> Blood cultures (2 sets) before antibiotics</label>
          <label><input type="checkbox" id="c_lactate"> Lactate measured (repeat if >2 mmol/L)</label>
          <label><input type="checkbox" id="c_abx"> Broad-spectrum antibiotics given</label>
          <label><input type="checkbox" id="c_fluids"> IV fluids started (30 ml/kg crystalloid)</label>
          <label><input type="checkbox" id="c_oxygen"> Oxygen started (target SpO₂ >94%)</label>
          <label><input type="checkbox" id="c_urine"> Urine output monitoring (aim >0.5 ml/kg/hr)</label>
        </div>
        <div style="margin-top:8px">
          <button id="completeBundleBtn" class="secondary">Mark Bundle Complete</button> 
          <button id="overrideBtn" class="secondary">Override/Delay</button>
        </div>
      `;
      $('dynamicContent').appendChild(container);

      $('startBundleBtn').addEventListener('click', () => { 
        startBundleTimer(); 
        log('Sepsis bundle timer started (1-hour target)'); 
      });
      
      const bundleChecks = ['c_bloodcult', 'c_lactate', 'c_abx', 'c_fluids', 'c_oxygen', 'c_urine'];
      bundleChecks.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', () => { 
            const done = bundleChecks.filter(i => document.getElementById(i) && document.getElementById(i).checked).length; 
            $('bundleProgress').innerText = done + '/6'; 
            localStorage.setItem('bundleState', JSON.stringify(bundleChecks.map(i => document.getElementById(i) ? document.getElementById(i).checked : false))); 
          });
        }
      });
      
      $('completeBundleBtn').addEventListener('click', () => { 
        const done = bundleChecks.filter(i => document.getElementById(i) && document.getElementById(i).checked).length; 
        const text = `Bundle marked complete (${done}/6 items)`; 
        $('bundleLog').innerHTML = `<div>[${new Date().toLocaleString()}] ${escapeHtml(text)}</div>` + $('bundleLog').innerHTML; 
        localStorage.setItem('bundleLog', $('bundleLog').innerHTML); 
        log(text); 
      });
      
      $('overrideBtn').addEventListener('click', () => { 
        const r = prompt('Reason for override/delay:'); 
        if (r) { 
          $('bundleLog').innerHTML = `<div>[${new Date().toLocaleString()}] OVERRIDE: ${escapeHtml(r)}</div>` + $('bundleLog').innerHTML; 
          localStorage.setItem('bundleLog', $('bundleLog').innerHTML); 
          log('Bundle override: ' + r); 
        } 
      });
      
      if (localStorage.getItem('bundleLog')) $('bundleLog').innerHTML = localStorage.getItem('bundleLog');
      $('bundleLogSection').classList.remove('hidden');
    }

    function renderFluidVaso(inputs) {
      const container = document.createElement('div'); 
      container.className = 'section';
      container.innerHTML = `
        <h4>Fluid & Vasopressor Guidance</h4>
        <div class="small">Recommended initial fluid: <strong>${inputs.severity === 'SEPTIC SHOCK' ? '30 ml/kg' : '20 ml/kg'}</strong> crystalloid</div>
        <div style="margin-top:8px"><label>Weight (kg)</label><input id="calcW" type="number" value="${inputs.weight || ''}"></div>
        <div style="margin-top:6px"><button id="calcFluidBtn" class="action">Calculate Fluid Volume</button> <span id="fluidVol" class="small"></span></div>
        <div style="margin-top:8px"><label>Post-fluid SBP (mmHg)</label><input id="post_sbp" type="number"></div>
        <div style="margin-top:6px"><label>Lactate (mmol/L)</label><input id="current_lactate" type="number" step="0.1" value="${inputs.lactate || ''}"></div>
        <div style="margin-top:8px"><button id="assessVasoBtn" class="secondary">Assess for vasopressor need</button><div id="vasoRec" class="small"></div></div>
      `;
      $('dynamicContent').appendChild(container);
      
      $('calcFluidBtn').addEventListener('click', () => { 
        const w = parseFloat($('calcW').value || 0); 
        if (w <= 0) { alert('Enter weight'); return; } 
        const vol = inputs.severity === 'SEPTIC SHOCK' ? Math.round(30 * w) : Math.round(20 * w);
        $('fluidVol').innerText = `${vol} ml (${inputs.severity === 'SEPTIC SHOCK' ? '30' : '20'} ml/kg)`; 
        log('Fluid calculated: ' + vol + ' ml'); 
      });
      
      $('assessVasoBtn').addEventListener('click', () => { 
        const post = parseFloat($('post_sbp').value || 0); 
        const lac = parseFloat($('current_lactate').value || 0); 
        if ((post > 0 && post < 90) || (lac >= 4)) { 
          $('vasoRec').innerHTML = 'Vasopressor indicated (Noradrenaline first-line). Prepare ICU transfer.'; 
          $('vasoRec').style.color = 'var(--danger)'; 
          log('Vasopressor indicated: postSBP=' + post + ' lactate=' + lac); 
          // Show noradrenaline calculator
          $('noradrenalineSection').classList.remove('hidden');
        } else { 
          $('vasoRec').innerHTML = 'No vasopressor indicated after fluid bolus; continue monitoring.'; 
          $('vasoRec').style.color = 'var(--muted)'; 
          log('Vasopressor not indicated: postSBP=' + post + ' lactate=' + lac); 
        } 
      });
    }

    function renderMonitoring(severityData) {
      const c = document.createElement('div'); 
      c.className = 'section'; 
      c.innerHTML = `
        <h4>Monitoring & Escalation</h4>
        <div class="small">Suggested: Vital signs ${severityData.level === 'SEPTIC SHOCK' ? 'Q15-30 min' : severityData.level === 'SEPSIS' ? 'Q1h' : 'Q4h'}, Lactate repeat ${severityData.level === 'SEPTIC SHOCK' ? 'Q2h' : severityData.level === 'SEPSIS' ? 'Q4h' : 'Q12-24h'}.</div>
        <ul style="margin-top:8px" id="triggersList"></ul>
      `; 
      $('dynamicContent').appendChild(c);
      
      const triggers = [];
      if (severityData.redFlags && severityData.redFlags.length) {
        severityData.redFlags.forEach(r => triggers.push(r));
      }
      if (severityData.qsofa >= 2) triggers.push('qSOFA ≥2 — high mortality risk');
      if (severityData.news2 >= 7) triggers.push('NEWS2 ≥7 — critical illness');
      else if (severityData.news2 >= 5) triggers.push('NEWS2 ≥5 — urgent review needed');
      
      const ul = $('triggersList'); 
      if (triggers.length === 0) {
        ul.innerHTML = '<li>No immediate escalation triggers</li>';
      } else {
        triggers.forEach(t => { 
          const li = document.createElement('li'); 
          li.innerText = t; 
          ul.appendChild(li); 
        });
      }
    }

    // Render sepsis guidance based on severity
    function renderSepsisGuidance(severity, inputs) {
      const container = document.createElement('div');
      container.className = 'section';
      
      let html = `<h4>Sepsis Classification & Management</h4>`;
      
      // ICU Alert if needed
      if (severity.icuAlert) {
        html += `
          <div class="icu-alarm" style="margin-bottom: 12px;">
            <div style="display:flex;align-items:center;gap:8px">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L3 20H21L12 2Z" stroke="var(--danger)" stroke-width="2"/>
                <path d="M12 10V14" stroke="var(--danger)" stroke-width="2"/>
                <circle cx="12" cy="17" r="1" fill="var(--danger)"/>
              </svg>
              <div>
                <strong>${severity.level === 'SEPTIC SHOCK' ? 'CRITICAL ALERT: SEPTIC SHOCK' : 'URGENT: SEPSIS'}</strong><br>
                <span class="small">Immediate intervention required</span>
              </div>
            </div>
          </div>
        `;
      }
      
      // Red Flags
      if (severity.redFlags.length > 0) {
        html += `
          <div class="warning" style="margin-bottom: 12px;">
            <strong>Organ Dysfunction Indicators:</strong>
            <ul style="margin: 4px 0 0 20px; font-size: 12px;">
              ${severity.redFlags.map(flag => `<li>${flag}</li>`).join('')}
            </ul>
          </div>
        `;
      }
      
      // Recommendations
      html += `
        <div class="card" style="background: var(--glass); padding: 12px; margin-bottom: 12px;">
          <strong>Recommended Actions:</strong>
          <ul style="margin: 8px 0 0 20px; font-size: 12px;">
            ${severity.recommendations.map(rec => `<li>${rec}</li>`).join('')}
          </ul>
        </div>
      `;
      
      // Timelines based on severity
      if (severity.level === 'SEPTIC SHOCK') {
        html += `
          <div class="small" style="color: var(--danger); font-weight: bold;">
            <strong>SEPTIC SHOCK BUNDLE (1-HOUR TARGET):</strong>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
              <div>✓ Measure lactate (repeat if >2)</div>
              <div>✓ Obtain blood cultures before antibiotics</div>
              <div>✓ Administer broad-spectrum antibiotics</div>
              <div>✓ Administer 30 ml/kg crystalloid for hypotension</div>
              <div style="grid-column: 1 / -1;">✓ Apply vasopressors if MAP <65 mmHg during/after fluid</div>
            </div>
          </div>
        `;
      } else if (severity.level === 'SEPSIS') {
        html += `
          <div class="small" style="color: #ffa500;">
            <strong>SEPSIS MANAGEMENT (1-HOUR TARGET):</strong>
            <div style="margin-top: 8px;">
              • Antibiotics within 1 hour<br>
              • Fluid resuscitation if indicated (20-30 ml/kg)<br>
              • Source identification and control<br>
              • Monitor for deterioration to septic shock<br>
              • Consider ICU/HDU referral
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
      $('dynamicContent').appendChild(container);
    }

    // Main assess flow with medically accurate sepsis classification
    $('assess').addEventListener('click', () => {
      clearDynamic(); 
      const inputs = collectInputs();
      
      // Calculate scores with medically accurate functions
      const news = calcNEWS2(inputs.temp || 0, inputs.hr || 0, inputs.rr || 0, inputs.sbp || 0, inputs.spo2 || 0, false);
      const qsofa = calcQSOFA(inputs.rr || 0, inputs.sbp || 0, inputs.gcs || 15);
      const sev = determineSeverity(inputs, news, qsofa);
      
      // Update display with color coding
      $('news2').innerText = news; 
      $('qsofa').innerText = qsofa; 
      $('severity').innerText = sev.level;
      
      // Apply color coding to severity pill
      const severityElement = $('severity');
      severityElement.className = 'pill';
      if (sev.level === 'SEPTIC SHOCK') {
        severityElement.classList.add('severity-shock');
      } else if (sev.level === 'SEPSIS') {
        severityElement.classList.add('severity-sepsis');
      } else if (sev.level === 'SUSPECTED SEPSIS') {
        severityElement.classList.add('severity-suspected');
      } else {
        severityElement.classList.add('severity-none');
      }
      
      // Save to patient records
      const patient = Object.assign({}, inputs, {
        news2: news,
        qsofa: qsofa,
        severity: sev.level,
        icuAlert: sev.icuAlert || false
      });
      savePatient(patient);
      renderPatientList();
      
      // Log with appropriate urgency
      const logMsg = `SEPSIS ASSESSMENT: ${sev.level} (NEWS2=${news}, qSOFA=${qsofa})`;
      if (sev.icuAlert) {
        log(`🚨 ${logMsg} - URGENT ACTION REQUIRED`);
      } else {
        log(logMsg);
      }
      
      // Show appropriate sections
      toggleAntibioticSection();
      toggleNoradrenalineSection(inputs);
      
      // Render sepsis guidance based on severity
      renderSepsisGuidance(sev, inputs);
      
      // Render sepsis six for septic shock and sepsis
      if (sev.level === 'SEPTIC SHOCK' || sev.level === 'SEPSIS') {
        renderSepsisSix();
      }
      
      // Render fluid/vasopressor guidance for hypotension or high lactate
      if ((inputs.sbp !== null && inputs.sbp < 100) || 
          (inputs.lactate !== null && inputs.lactate >= 2)) {
        renderFluidVaso(Object.assign({}, inputs, {
          lactate: inputs.lactate,
          weight: inputs.weight,
          severity: sev.level
        }));
      }
      
      // Always show monitoring
      renderMonitoring(sev);
    });
  </script>
</body>
</html>